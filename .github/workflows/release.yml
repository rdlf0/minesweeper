name: Release

on:
  release:
    types:
      - published

env:
  ARTIFACT_NAME: minesweeper-compiled

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    env:
      ARTIFACT_PATH: artifact
      ASSET_NAME: minesweeper.zip
      ASSET_TYPE: application/zip
    steps:
      - name: Check out the code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.sha }}

      - name: Compile the source
        run: tsc --outDir "${ARTIFACT_PATH}/dist"

      - name: Prepare artifact
        run: mv index.html require.js main.js styles.css favicon.svg robots.txt sitemap.xml manifest.webmanifet sw.js LICENSE assets $ARTIFACT_PATH

      - name: Prepare release asset
        run: zip -r $ASSET_NAME $ARTIFACT_PATH

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./${{ env.ARTIFACT_PATH }}

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./${{ env.ASSET_NAME }}
          asset_name: ${{ env.ASSET_NAME }}
          asset_content_type: ${{ env.ASSET_TYPE }}

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-20.04
    env:
      AWS_S3_BUCKET: theminesweeper.com
      AWS_REGION: us-east-2
      AWS_ROLE: arn:aws:iam::067429979131:role/github_actions_minesweeper
    environment:
      name: production
      url: "https://${{ env.AWS_S3_BUCKET }}"
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      # The AWS CLI doesn't allow appending to the content type
      # so we have to sync the different file types separately
      - name: Upload to S3 (HTML)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --delete
          --no-progress
          --acl public-read
          --exclude "*"
          --include "index.html"
          --cache-control "no-cache"
          --content-type "text/html; charset=utf-8"

      - name: Upload to S3 (CSS)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.css"
          --cache-control "max-age=31536000 immutable"
          --content-type "text/css; charset=utf-8"

      - name: Upload to S3 (JS)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.js"
          --cache-control "max-age=31536000 immutable"
          --content-type "application/javascript; charset=utf-8"

      - name: Upload to S3 (SVG)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.svg"
          --cache-control "max-age=31536000 immutable"
          --content-type "image/svg+xml; charset=utf-8"

      - name: Upload to S3 (PNG)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.png"
          --cache-control "max-age=31536000 immutable"
          --content-type "image/png; charset=utf-8"

      - name: Upload to S3 (WEBMANIFEST)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.webmanifest"
          --cache-control "max-age=31536000 immutable"
          --content-type "application/manifest+json; charset=utf-8"

      - name: Upload to S3 (TXT)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.txt"
          --cache-control "max-age=31536000 immutable"
          --content-type "text/plain; charset=utf-8"

      - name: Upload to S3 (XML)
        run: >
          aws s3 sync $ARTIFACT_NAME s3://$AWS_S3_BUCKET
          --no-progress
          --acl public-read
          --exclude "*"
          --include "*.xml"
          --cache-control "max-age=31536000 immutable"
          --content-type "application/xml; charset=utf-8"
